<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="webpack配置详解"><meta name="keywords" content=""><meta name="author" content="Doug Flands"><meta name="copyright" content="Doug Flands"><title>webpack配置详解 | Flands Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="manifest" href="/manifest.json"><link rel="manifest" href="/manifest.json"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#entry-amp-output"><span class="toc-number">1.</span> <span class="toc-text">entry &amp; output</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#source-map"><span class="toc-number">2.</span> <span class="toc-text">source-map</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#loader"><span class="toc-number">3.</span> <span class="toc-text">loader</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#plugin"><span class="toc-number">4.</span> <span class="toc-text">plugin</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#script命令"><span class="toc-number">5.</span> <span class="toc-text">script命令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#postcss-config-js"><span class="toc-number">6.</span> <span class="toc-text">postcss-config.js</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#监听文件变化"><span class="toc-number">7.</span> <span class="toc-text">监听文件变化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#简单方式"><span class="toc-number">7.1.</span> <span class="toc-text">简单方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一般方式"><span class="toc-number">7.2.</span> <span class="toc-text">一般方式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#热模块更新-HMR"><span class="toc-number">8.</span> <span class="toc-text">热模块更新 HMR</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#处理es6-babel"><span class="toc-number">9.</span> <span class="toc-text">处理es6 babel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#babel-polifill"><span class="toc-number">9.1.</span> <span class="toc-text">babel polifill</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#组件库问题"><span class="toc-number">9.2.</span> <span class="toc-text">组件库问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#react"><span class="toc-number">9.3.</span> <span class="toc-text">react</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Tree-Shaking"><span class="toc-number">10.</span> <span class="toc-text">Tree Shaking</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分环境打包"><span class="toc-number">11.</span> <span class="toc-text">分环境打包</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Code-Splitting代码分割"><span class="toc-number">12.</span> <span class="toc-text">Code Splitting代码分割</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#第一种方式"><span class="toc-number">12.1.</span> <span class="toc-text">第一种方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第二种方式"><span class="toc-number">12.2.</span> <span class="toc-text">第二种方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异步加载"><span class="toc-number">12.3.</span> <span class="toc-text">异步加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#splitChunksPlugin"><span class="toc-number">12.4.</span> <span class="toc-text">splitChunksPlugin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#splitChunks默认选项"><span class="toc-number">12.4.1.</span> <span class="toc-text">splitChunks默认选项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LazyLoading懒加载"><span class="toc-number">12.5.</span> <span class="toc-text">LazyLoading懒加载</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#打包分析"><span class="toc-number">13.</span> <span class="toc-text">打包分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#analyse"><span class="toc-number">13.1.</span> <span class="toc-text">analyse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他分析工具"><span class="toc-number">13.2.</span> <span class="toc-text">其他分析工具</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#webpack打包推荐JS写法"><span class="toc-number">14.</span> <span class="toc-text">webpack打包推荐JS写法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#查看代码复用率"><span class="toc-number">15.</span> <span class="toc-text">查看代码复用率</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#preloading-prefetching"><span class="toc-number">16.</span> <span class="toc-text">preloading\prefetching</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#异步文件命名"><span class="toc-number">17.</span> <span class="toc-text">异步文件命名</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#css代码分割"><span class="toc-number">18.</span> <span class="toc-text">css代码分割</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#浏览器缓存"><span class="toc-number">19.</span> <span class="toc-text">浏览器缓存</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#shimming-垫片"><span class="toc-number">20.</span> <span class="toc-text">shimming 垫片</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#改变模块的this"><span class="toc-number">21.</span> <span class="toc-text">改变模块的this</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#环境变量"><span class="toc-number">22.</span> <span class="toc-text">环境变量</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#开发框架的打包方式"><span class="toc-number">23.</span> <span class="toc-text">开发框架的打包方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PWA"><span class="toc-number">24.</span> <span class="toc-text">PWA</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dev-server"><span class="toc-number">25.</span> <span class="toc-text">dev - server</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#单页面路由问题"><span class="toc-number">26.</span> <span class="toc-text">单页面路由问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#提高-webpack-打包速度"><span class="toc-number">27.</span> <span class="toc-text">提高 webpack 打包速度</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#编写Loader"><span class="toc-number">28.</span> <span class="toc-text">编写Loader</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#编写Plugin"><span class="toc-number">29.</span> <span class="toc-text">编写Plugin</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#写一个类似Webpack的工具"><span class="toc-number">30.</span> <span class="toc-text">写一个类似Webpack的工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#依赖包"><span class="toc-number">30.1.</span> <span class="toc-text">依赖包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件结构"><span class="toc-number">30.2.</span> <span class="toc-text">文件结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件内容"><span class="toc-number">30.3.</span> <span class="toc-text">文件内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#输出"><span class="toc-number">30.4.</span> <span class="toc-text">输出</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://flands.com/avatar/192.jpg"></div><div class="author-info__name text-center">Doug Flands</div><div class="author-info__description text-center">Flands</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">54</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">19</span></a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Flands Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">webpack配置详解</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-07-10</time></div><div class="article-container" id="post-content"><p>webpack配置方式及如何优化</p>
<a id="more"></a>
<h1 id="entry-amp-output"><a href="#entry-amp-output" class="headerlink" title="entry &amp; output"></a>entry &amp; output</h1><p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 入口文件</span></span><br><span class="line">  entry: <span class="string">'./index.js'</span></span><br><span class="line">  <span class="comment">// 等同于</span></span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">'./index.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输出</span></span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">'bundle.js'</span>,</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'src'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 多文件打包</span></span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">'./index.js'</span>,</span><br><span class="line">    sub: <span class="string">'./index.js'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">'[name].js'</span>,</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'src'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// js上传到cdn</span></span><br><span class="line">  output: &#123;</span><br><span class="line">    publicPath: <span class="string">'http://cdn.com/'</span>,</span><br><span class="line">    filename: <span class="string">'[name].js'</span>,</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'src'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="source-map"><a href="#source-map" class="headerlink" title="source-map"></a>source-map</h1><p>源代码和生成代码的映射
webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 出错后可以定位</span></span><br><span class="line"><span class="comment">// inline: map文件base64到main.js，不单独拿出来</span></span><br><span class="line"><span class="comment">// cheap: 精确到行,只map业务代码</span></span><br><span class="line"><span class="comment">// module: map所有模块代码</span></span><br><span class="line"><span class="comment">// eval: 不翻译为base64，存在eval的方式执行</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  devtool: <span class="string">'source-map'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最佳实践:  </p>
<ul>
<li>开发环境: <code>cheap-module-eval-source-map</code></li>
<li>线上: <code>cheap-module-source-map</code></li>
</ul>
<h1 id="loader"><a href="#loader" class="headerlink" title="loader"></a>loader</h1><p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指定路径用node的path方法，__dirname为wepack.config目录</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 打包环境</span></span><br><span class="line">  mode: <span class="string">'production'</span></span><br><span class="line">  <span class="comment">// 此环境下不压缩</span></span><br><span class="line">  mode: <span class="string">'development'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// loader，执行顺序-从下到上</span></span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.jpg$/</span>,</span><br><span class="line">        use: &#123;</span><br><span class="line">          <span class="comment">// https://webpack.js.org/loaders/file-loader/</span></span><br><span class="line">          loader: <span class="string">'file-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            <span class="comment">// placeholder 占位符，打包后的文件名</span></span><br><span class="line">            <span class="comment">// [name]: 老文件名</span></span><br><span class="line">            <span class="comment">// [hash]: hash值</span></span><br><span class="line">            <span class="comment">// [ext]: 文件后缀</span></span><br><span class="line">            name: <span class="string">'[name]_[hash].[ext]'</span>,</span><br><span class="line">            <span class="comment">// 打包到目录下</span></span><br><span class="line">            outputPath: <span class="string">'img/'</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.jpg$/</span>,</span><br><span class="line">        use: &#123;</span><br><span class="line">          <span class="comment">// https://webpack.js.org/loaders/url-loader/</span></span><br><span class="line">          <span class="comment">// 和file-loader类似，但是打包的图片会转为base64</span></span><br><span class="line">          loader: <span class="string">'url-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            <span class="comment">// placeholder 占位符，打包后的文件名</span></span><br><span class="line">            <span class="comment">// [name]: 老文件名</span></span><br><span class="line">            <span class="comment">// [hash]: hash值</span></span><br><span class="line">            <span class="comment">// [ext]: 文件后缀</span></span><br><span class="line">            name: <span class="string">'[name]_[hash].[ext]'</span>,</span><br><span class="line">            <span class="comment">// 打包到目录下</span></span><br><span class="line">            outputPath: <span class="string">'img/'</span>,</span><br><span class="line">            <span class="comment">// 小于2kb的才打包到JS</span></span><br><span class="line">            limit: <span class="number">2048</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="comment">// style-loader css内容挂载到head里</span></span><br><span class="line">          <span class="comment">// css-loader 分析多个css文件关系，合并</span></span><br><span class="line">          <span class="string">'style-loader'</span>, <span class="string">'css-loader'</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="comment">// sass-loader 对sass分析</span></span><br><span class="line">          <span class="comment">// postcss-loader 配合插件 autoprefixer 添加css前缀，-webkit-</span></span><br><span class="line">          <span class="string">'style-loader'</span>, </span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'css-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              <span class="comment">// import的css里import其他的css时，在打包前，需要用下面2个loader处理</span></span><br><span class="line">              importLoaders: <span class="number">2</span>,</span><br><span class="line">              <span class="comment">// css-modules，使用方式如下</span></span><br><span class="line">              <span class="comment">// import style from 'x.scss'</span></span><br><span class="line">              <span class="comment">// style.a</span></span><br><span class="line">              modules: <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;, </span><br><span class="line">          <span class="string">'sass-loader'</span>, </span><br><span class="line">          <span class="string">'postcss-loader'</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 字体文件</span></span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(eot|ttf|svg)$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="comment">// style-loader css内容挂载到head里</span></span><br><span class="line">          <span class="comment">// css-loader 分析多个css文件关系，合并</span></span><br><span class="line">          <span class="string">'file-loader'</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="plugin"><a href="#plugin" class="headerlink" title="plugin"></a>plugin</h1><p><code>npm i html-webpack-plugin -D</code>  </p>
<p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">'html-webpack-plugin'</span>)</span><br><span class="line"><span class="keyword">const</span> CleanWebpackPlugin = <span class="built_in">require</span>(<span class="string">'clean-webpack-plugin'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugin: [</span><br><span class="line">    <span class="comment">// 打包结束后自动生成index.html，并把打包后的js自动引入</span></span><br><span class="line">    <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">      <span class="comment">// 作为模板</span></span><br><span class="line">      template: <span class="string">'src/index.html'</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">// 打包前删除dist目录下的文件</span></span><br><span class="line">    <span class="keyword">new</span> CleanWebpackPlugin([<span class="string">'dist'</span>])</span><br><span class="line"></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="script命令"><a href="#script命令" class="headerlink" title="script命令"></a>script命令</h1><p>package.json
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">script: &#123;</span><br><span class="line">  <span class="string">"bundle"</span>: <span class="string">"webpack"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="postcss-config-js"><a href="#postcss-config-js" class="headerlink" title="postcss-config.js"></a>postcss-config.js</h1><p>当webpack配置用到时，需要此配置文件
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'autoprefixer'</span>)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="监听文件变化"><a href="#监听文件变化" class="headerlink" title="监听文件变化"></a>监听文件变化</h1><h2 id="简单方式"><a href="#简单方式" class="headerlink" title="简单方式"></a>简单方式</h2><p>package.json
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "watch": "webpack --watch"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="一般方式"><a href="#一般方式" class="headerlink" title="一般方式"></a>一般方式</h2><p><code>npm i webpack-dev-server -D</code></p>
<p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    <span class="comment">// 监听目录</span></span><br><span class="line">    contentBase: <span class="string">'./dist'</span>,</span><br><span class="line">    <span class="comment">// 打开端口后自动访问地址</span></span><br><span class="line">    open: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 发到api的请求转到 loaclhost:3000</span></span><br><span class="line">    proxy: &#123;</span><br><span class="line">      <span class="string">'/api'</span>: <span class="string">'http://loaclhost:3000'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>package.json
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "start": "webpack-dev-server"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="热模块更新-HMR"><a href="#热模块更新-HMR" class="headerlink" title="热模块更新 HMR"></a>热模块更新 HMR</h1><p>改变样式代码时只改变样式，不刷新页面</p>
<p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    hot: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 即使不生效，也不自动刷新</span></span><br><span class="line">    hotOnly: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin()</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>index.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">'./a'</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">'./b'</span></span><br><span class="line"></span><br><span class="line">a()</span><br><span class="line">b()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点击页面，改变了a在页面上的数据，此时修改b文件里的数据，页面不会刷新</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">module</span>.hot) &#123;</span><br><span class="line">  <span class="comment">// params: 引入的文件, 回调</span></span><br><span class="line">  <span class="built_in">module</span>.hot.accept(<span class="string">'./b'</span>, () =&gt; &#123;</span><br><span class="line">    b()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="处理es6-babel"><a href="#处理es6-babel" class="headerlink" title="处理es6 babel"></a>处理es6 babel</h1><p><code>npm i --save-dev babel-loader @babel/core</code><br><code>npm install @babel/preset-env --save-dev</code>  </p>
<p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123; </span><br><span class="line">        test: <span class="regexp">/\.js$/</span>, </span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>, </span><br><span class="line">        loader: <span class="string">"babel-loader"</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">          presets: [[<span class="string">"@babel/preset-env"</span>, &#123;</span><br><span class="line">            <span class="comment">// 运行的环境，浏览器版本</span></span><br><span class="line">            targets: &#123;</span><br><span class="line">              <span class="comment">// 只做对chrome版本&gt;67的兼容</span></span><br><span class="line">              chrome: <span class="string">"67"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// poltfill时不加所有，只加业务代码用到的</span></span><br><span class="line">            useBuiltIns: <span class="string">'usage'</span></span><br><span class="line">          &#125;]]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="babel-polifill"><a href="#babel-polifill" class="headerlink" title="babel polifill"></a>babel polifill</h2><p>将Promise转es5
<code>npm install --save @babel/polyfile</code></p>
<p>如果规则放在 babelrc 内则不用在项目中写
index.js
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &quot;@babel/polyfill&quot;;</span><br></pre></td></tr></table></figure></p>
<h2 id="组件库问题"><a href="#组件库问题" class="headerlink" title="组件库问题"></a>组件库问题</h2><p>写组件库的话会污染全局变量<br><code>npm install --save-dev @babel/plugin-transform-runtime</code><br><code>npm install --save @babel/runtime</code><br><code>npm install --save @babel/runtime-corejs2</code>  </p>
<p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123; </span><br><span class="line">        test: <span class="regexp">/\.js$/</span>, </span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>, </span><br><span class="line">        loader: <span class="string">"babel-loader"</span>,</span><br><span class="line">        <span class="comment">// 下面内容也可以新建 .babelrc 放进去，这里就不用写了</span></span><br><span class="line">        options: &#123;</span><br><span class="line">          <span class="string">"plugins"</span>: [</span><br><span class="line">            [</span><br><span class="line">              <span class="string">"@babel/plugin-transform-runtime"</span>,</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="string">"absoluteRuntime"</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="string">"corejs"</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="string">"helpers"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"regenerator"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"useESModules"</span>: <span class="literal">false</span></span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="react"><a href="#react" class="headerlink" title="react"></a>react</h2><p><code>npm install --save-dev @babel/preset-react</code>
<code>npm i react react-dom --save</code> </p>
<p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123; </span><br><span class="line">        test: <span class="regexp">/\.js$/</span>, </span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>, </span><br><span class="line">        loader: <span class="string">"babel-loader"</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">          presets: [[<span class="string">"@babel/preset-env"</span>, &#123;</span><br><span class="line">            targets: &#123;</span><br><span class="line">              chrome: <span class="string">"67"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            useBuiltIns: <span class="string">'usage'</span></span><br><span class="line">          &#125;],</span><br><span class="line">          <span class="string">'@babel/preset-react'</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Tree-Shaking"><a href="#Tree-Shaking" class="headerlink" title="Tree Shaking"></a>Tree Shaking</h1><p>打包时模块内没用到的东西去掉<br>只支持ES Module方式 (import) </p>
<p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    optimization: &#123;</span><br><span class="line">      <span class="comment">// 开发环境加这个</span></span><br><span class="line">      usedExports: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>package.json
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// polyfile可能导出的兼容未使用，导致Tree Shaking 把整个polyfile去掉，所以加入白名单</span><br><span class="line">"sideEffects": ["@babel/polyfile"]</span><br><span class="line">// import './css.css'可能会去掉，加入名单</span><br><span class="line">"sideEffects": ["*.css"]</span><br><span class="line">// 不在文件直接Import，改为false</span><br><span class="line">"sideEffects": false</span><br></pre></td></tr></table></figure></p>
<h1 id="分环境打包"><a href="#分环境打包" class="headerlink" title="分环境打包"></a>分环境打包</h1><p>将<code>webpack.dev.js</code>拷贝一份<code>webpack.pro.js</code>,对<code>webpack.pro.js</code>重新配置</p>
<p>package.json
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"script": &#123;</span><br><span class="line">  "dev": "webpack-dev-server --config webpack.dev.js",</span><br><span class="line">  "build": "webpack --config webpack.pro.js",</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>抽离通用的配置项
<code>npm i wepack-merge -D</code></p>
<p>webpack.common.js
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// 通用的配置</span><br></pre></td></tr></table></figure></p>
<p>webpack.dev.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">'webpack-merge'</span>)</span><br><span class="line"><span class="keyword">const</span> commonConfig = <span class="built_in">require</span>(./webpack.common.js)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> devConfig = &#123;&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = merge(commonConfig, devConfig)</span><br></pre></td></tr></table></figure></p>
<h1 id="Code-Splitting代码分割"><a href="#Code-Splitting代码分割" class="headerlink" title="Code Splitting代码分割"></a>Code Splitting代码分割</h1><p>假设要引入lodash,不分割会导致整个库打包至main.js<br>拆分后，业务逻辑变更插件不会重新加载</p>
<h2 id="第一种方式"><a href="#第一种方式" class="headerlink" title="第一种方式"></a>第一种方式</h2><p>webpack
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">entry: &#123;</span><br><span class="line">  lodash: <span class="string">'./src/lodash.js'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>src/loadsh.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'lodash'</span></span><br><span class="line"><span class="built_in">window</span>._ = _</span><br></pre></td></tr></table></figure></p>
<h2 id="第二种方式"><a href="#第二种方式" class="headerlink" title="第二种方式"></a>第二种方式</h2><p>自动做分割<br>src/index.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'lodash'</span></span><br></pre></td></tr></table></figure></p>
<p>webpack
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">optimization: &#123;</span><br><span class="line">  splitChunks: &#123;</span><br><span class="line">    chunks: <span class="string">'all'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="异步加载"><a href="#异步加载" class="headerlink" title="异步加载"></a>异步加载</h2><p>实验性语法，babel转换
<code>npm install babel-plugin-dynamic-import-webpack --save-dev</code></p>
<p>.babelrc
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plugins: [<span class="string">"babel-plugin-dynamic-import-webpack"</span>]</span><br></pre></td></tr></table></figure></p>
<p>index.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getComponents</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">import</span>(<span class="string">'lodash'</span>).then(<span class="function">(<span class="params">&#123;<span class="keyword">default</span>: _&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 异步加载</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="splitChunksPlugin"><a href="#splitChunksPlugin" class="headerlink" title="splitChunksPlugin"></a>splitChunksPlugin</h2><p>index.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getComponents</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 魔法注释 代码分割对lodash打包时起名为lodash</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName:"lodash" */</span> <span class="string">'lodash'</span>).then(<span class="function">(<span class="params">&#123;<span class="keyword">default</span>: _&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>npm uninstall babel-plugin-dynamic-import-webpack</code><br><code>npm i @babel/plugin-syntax-dynamic-import --save-dev</code></p>
<ul>
<li>使打包的文件前缀无vendors
webpack<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">optimization: &#123;</span><br><span class="line">  splitChunks: &#123;</span><br><span class="line">    chunks: <span class="string">'all'</span>,</span><br><span class="line">    cacheGroups: &#123;</span><br><span class="line">      vendors: <span class="literal">false</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="splitChunks默认选项"><a href="#splitChunks默认选项" class="headerlink" title="splitChunks默认选项"></a>splitChunks默认选项</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">splitChunks: &#123;</span><br><span class="line">  <span class="comment">// 代码分割只对异步代码生效</span></span><br><span class="line">  chunks: <span class="string">"async"</span>,</span><br><span class="line">  <span class="comment">// 对所有代码生效</span></span><br><span class="line">  chunks: <span class="string">'all'</span>,</span><br><span class="line">  <span class="comment">// 对同步代码生效</span></span><br><span class="line">  chunks: <span class="string">'initial'</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 引入的模块大于30kb才做分割</span></span><br><span class="line">  minSize: <span class="number">30000</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对分割的模块做50kb的分文件分割，一般不用</span></span><br><span class="line">  maxSize: <span class="number">50000</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当模块用了多少次的时候才分割</span></span><br><span class="line">  minChunks: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 最大分割的模块数，只分割前5个</span></span><br><span class="line">  maxAsyncRequests: <span class="number">5</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 入口文件分割的模块数，最大3个</span></span><br><span class="line">  maxInitialRequests: <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 文件生成的连接符</span></span><br><span class="line">  automaticNameDelimiter: <span class="string">'~'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 分割的文件名在cacheGroups里定义是否有效</span></span><br><span class="line">  name: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓存组，从上面的规则走完后模块缓存到缓存组内，然后分割</span></span><br><span class="line">  cacheGroups: &#123;</span><br><span class="line">    <span class="comment">// 当为所有代码生效时，此项意思为，对node_modules内的文件生效</span></span><br><span class="line">    <span class="comment">// 打包后为vendors~main.js</span></span><br><span class="line">    <span class="comment">// vendors为下面配置的组的名字(key)</span></span><br><span class="line">    <span class="comment">// main意思是该分割出的文件的入口文件为main.js，对应webpack的entry配置项</span></span><br><span class="line">    vendors: &#123;</span><br><span class="line">      test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">      <span class="comment">// 值越大优先级越高，模块就会被分割到此文件内</span></span><br><span class="line">      priority: <span class="number">-10</span>,</span><br><span class="line">      <span class="comment">// 分割出的文件名为vendors.js</span></span><br><span class="line">      filename: <span class="string">'vendors.js'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">default</span>: &#123;</span><br><span class="line">      minChunks: <span class="number">2</span>,</span><br><span class="line">      priority: <span class="number">-20</span>,</span><br><span class="line">      <span class="comment">// A,B文件中A引用了B，但也有其他文件引用了B，则不会重复添加到分割文件中</span></span><br><span class="line">      reuseExistingChunk: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="LazyLoading懒加载"><a href="#LazyLoading懒加载" class="headerlink" title="LazyLoading懒加载"></a>LazyLoading懒加载</h2><p>使用<code>import(&#39;xxx&#39;)</code>加载的代码，加载时间不固定，具体看触发时机
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getComponents</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">import</span>(<span class="string">'lodash'</span>).then()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="打包分析"><a href="#打包分析" class="headerlink" title="打包分析"></a>打包分析</h1><h2 id="analyse"><a href="#analyse" class="headerlink" title="analyse"></a>analyse</h2><p>package.json
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">"script": &#123;</span><br><span class="line">  "dev-build": "webpack --config .....",</span><br><span class="line">  "//": "新加",</span><br><span class="line">  "//": "打包过程中，把打包的描述添加到stats里",</span><br><span class="line">  "dev-build": "webpack --profile --json &gt; stats.json --config .....",</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上传文件到 </p>
<blockquote>
<p>webpack.github.io/analyse/</p>
</blockquote>
<p>可以看到分析</p>
<h2 id="其他分析工具"><a href="#其他分析工具" class="headerlink" title="其他分析工具"></a>其他分析工具</h2><blockquote>
<p><a href="https://webpack.js.org/guides/code-splitting/#bundle-analysis" target="_blank" rel="noopener">https://webpack.js.org/guides/code-splitting/#bundle-analysis</a></p>
</blockquote>
<h1 id="webpack打包推荐JS写法"><a href="#webpack打包推荐JS写法" class="headerlink" title="webpack打包推荐JS写法"></a>webpack打包推荐JS写法</h1><p>以前的写法
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给元素添加click事件</span></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'click'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 干活</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>推荐写法
index.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'click'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">import</span>(<span class="string">'./click.js'</span>).then(<span class="function"><span class="params">func</span> =&gt;</span> &#123;</span><br><span class="line">    func()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>click.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">handleClick</span>(<span class="params"></span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="查看代码复用率"><a href="#查看代码复用率" class="headerlink" title="查看代码复用率"></a>查看代码复用率</h1><p>控制台 -&gt; Sources -&gt; ctrl+shift+p -&gt; 输入coverage  </p>
<blockquote>
<p><a href="https://zhuanlan.zhihu.com/p/26281581" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/26281581</a></p>
</blockquote>
<h1 id="preloading-prefetching"><a href="#preloading-prefetching" class="headerlink" title="preloading\prefetching"></a>preloading\prefetching</h1><blockquote>
<p><a href="https://webpack.js.org/guides/code-splitting/#prefetchingpreloading-modules" target="_blank" rel="noopener">https://webpack.js.org/guides/code-splitting/#prefetchingpreloading-modules</a></p>
</blockquote>
<p>等核心代码加载完成后，页面空闲时加载异步代码<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(<span class="comment">/* webpackPrefetch: true */</span> <span class="string">'./click.js'</span>).then(<span class="function"><span class="params">func</span> =&gt;</span> &#123;</span><br><span class="line">    func()</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure></p>
<h1 id="异步文件命名"><a href="#异步文件命名" class="headerlink" title="异步文件命名"></a>异步文件命名</h1><p>webpack.common.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 入口文件走下面的filename配置</span></span><br><span class="line">entry: &#123;</span><br><span class="line">  main: <span class="string">'./src/index.js'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 省略</span></span><br><span class="line">output: &#123;</span><br><span class="line">  filename: <span class="string">'[name],js'</span>,</span><br><span class="line">  <span class="comment">// 被入口文件引用的文件走下面的配置项</span></span><br><span class="line">  chunkFilename: <span class="string">'[name].chunk.js'</span>,</span><br><span class="line">  path: path.resolve(__dirname, <span class="string">'../dist'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="css代码分割"><a href="#css代码分割" class="headerlink" title="css代码分割"></a>css代码分割</h1><blockquote>
<p><a href="https://webpack.js.org/plugins/mini-css-extract-plugin/" target="_blank" rel="noopener">https://webpack.js.org/plugins/mini-css-extract-plugin/</a></p>
</blockquote>
<p>此插件可以对多入口文件打包，具体看官网文档<br>不对css做Tree Shaking  </p>
<p>package.json
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"sideEffects"</span>: [</span><br><span class="line">    <span class="string">"*.css"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>wepack.common.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">'mini-css-extract-plugin'</span>);</span><br><span class="line"><span class="comment">// css压缩</span></span><br><span class="line"><span class="keyword">const</span> OptimizeCSSAssetsPlugin = <span class="built_in">require</span>(<span class="string">'optimize-css-assets-webpack-plugin'</span>);</span><br><span class="line"><span class="comment">// css压缩</span></span><br><span class="line">optimization: &#123;</span><br><span class="line">  minimizer: [<span class="keyword">new</span> TerserJSPlugin(&#123;&#125;), <span class="keyword">new</span> OptimizeCSSAssetsPlugin(&#123;&#125;)],</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">      use: [</span><br><span class="line">        &#123;</span><br><span class="line">          loader: MiniCssExtractPlugin.loader,</span><br><span class="line">          options: &#123;</span><br><span class="line">            publicPath: <span class="string">'../'</span>,</span><br><span class="line">            hmr: process.env.NODE_ENV === <span class="string">'development'</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'css-loader'</span>,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br><span class="line">plugins: [</span><br><span class="line">  <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">    <span class="comment">// 被页面直接引用的配置</span></span><br><span class="line">    filename: <span class="string">'[name].css'</span>,</span><br><span class="line">    <span class="comment">// 被间接引用的配置</span></span><br><span class="line">    chunkFilename: <span class="string">'[id].css'</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">],</span><br></pre></td></tr></table></figure></p>
<h1 id="浏览器缓存"><a href="#浏览器缓存" class="headerlink" title="浏览器缓存"></a>浏览器缓存</h1><p>文件源码不变，文件名不会变
webpack.prod.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">output: &#123;</span><br><span class="line">  filename: <span class="string">'[name].[contenthash].js'</span>,</span><br><span class="line">  chunkFilename: <span class="string">'[name].[contenthash].js'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>webpack3以下可能出现每次打包即使源码不变，hash也会变</p>
<p>webpack.common.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">optimization: &#123;</span><br><span class="line">  runtimeChunk: &#123;</span><br><span class="line">    name: <span class="string">'runtime'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="shimming-垫片"><a href="#shimming-垫片" class="headerlink" title="shimming 垫片"></a>shimming 垫片</h1><p>模块化导致写的模块引入的库可能不在package里<br>这里加入配置，可以自动加载  </p>
<p>webpack.common.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> webpack <span class="keyword">from</span> <span class="string">'webpack'</span></span><br><span class="line"></span><br><span class="line">plugins: [</span><br><span class="line">  <span class="keyword">new</span> webpack.ProvidePlugin(&#123;</span><br><span class="line">    <span class="comment">// 命名: 库</span></span><br><span class="line">    $: <span class="string">'jquery'</span>,</span><br><span class="line">    <span class="comment">// 将lodash的join方法命名为_join</span></span><br><span class="line">    _join: [<span class="string">'lodash'</span>, <span class="string">'join'</span>]</span><br><span class="line">  &#125;)</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>模块
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'jquery'</span></span><br><span class="line"><span class="comment">// 自动完成命名</span></span><br><span class="line"><span class="comment">// $()...</span></span><br></pre></td></tr></table></figure></p>
<h1 id="改变模块的this"><a href="#改变模块的this" class="headerlink" title="改变模块的this"></a>改变模块的this</h1><p><code>npm i imports-loader --save-dev</code></p>
<p>webpack.common.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rules: [</span><br><span class="line">  &#123;</span><br><span class="line">    test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">    <span class="comment">// ……</span></span><br><span class="line">    use: [&#123;</span><br><span class="line">      loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="comment">// 改变模块内的this为window</span></span><br><span class="line">      loader: <span class="string">'imports-loader?this=&gt;window'</span></span><br><span class="line">    &#125;],</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><p>webpack.common.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">'webpack-merge'</span>)</span><br><span class="line"><span class="keyword">const</span> devConfig = <span class="built_in">require</span>(<span class="string">'./webpack.dev.js'</span>)</span><br><span class="line"><span class="keyword">const</span> proConfig = <span class="built_in">require</span>(<span class="string">'./webpack.pro.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack配置</span></span><br><span class="line"><span class="keyword">const</span> commonConfig = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">env</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (env &amp;&amp; env.production) &#123;</span><br><span class="line">    <span class="comment">// 生产环境</span></span><br><span class="line">    <span class="keyword">return</span> merge(commonConfig, proConfig)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 开发环境</span></span><br><span class="line">    <span class="keyword">return</span> merge(commonConfig, devConfig)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在打包命令里添加属性</p>
<p>package.json
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "build": "webpack --env.production --config"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也可以写<br><code>webpack --env.production=abc --config</code><br>这样的话环境变量就有值<br><code>env.production === abc</code></p>
<h1 id="开发框架的打包方式"><a href="#开发框架的打包方式" class="headerlink" title="开发框架的打包方式"></a>开发框架的打包方式</h1><ul>
<li><p>library
<code>npm init</code>  </p>
</li>
<li><p>package.json</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"library"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="string">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"build"</span>: <span class="string">"webpack"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"author"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="string">"license"</span>: <span class="string">"MIT"</span>,</span><br><span class="line">  <span class="string">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"webpack"</span>: <span class="string">"^4.35.2"</span>,</span><br><span class="line">    <span class="string">"webpack-cli"</span>: <span class="string">"^3.3.5"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>webpack.config.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">'production'</span>,</span><br><span class="line">  entry: <span class="string">'./src/index.js'</span>,</span><br><span class="line">  <span class="comment">// 库中引用了lodash，外部也用了loadsh则会打包两份，这里提取出来</span></span><br><span class="line">  externals: [<span class="string">"lodash"</span>],</span><br><span class="line"></span><br><span class="line">  externals: &#123;</span><br><span class="line">    lodash: &#123;</span><br><span class="line">      <span class="comment">// 如果库在commonjs环境使用，加载时必须为lodash不能为_</span></span><br><span class="line">      commonjs: <span class="string">'lodash'</span>,</span><br><span class="line">      <span class="comment">// 如果为script标签引入，则lodash全局变量为_</span></span><br><span class="line">      root: <span class="string">'_'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'library.js'</span>,</span><br><span class="line">    <span class="comment">// 打包的代码挂在到全局变量中</span></span><br><span class="line">    <span class="comment">// script标签引入，library全局变量</span></span><br><span class="line">    library: <span class="string">'library'</span>,</span><br><span class="line">    <span class="comment">// 通用导出，可被多种方式引入</span></span><br><span class="line">    libraryTarget: <span class="string">'umd'</span>,</span><br><span class="line">    <span class="comment">// 只标签导入，全局为this.library</span></span><br><span class="line">    libraryTarget: <span class="string">'this'</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>/src</p>
<ul>
<li><p>math.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> math <span class="keyword">from</span> <span class="string">'./math'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123; math &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h1 id="PWA"><a href="#PWA" class="headerlink" title="PWA"></a>PWA</h1><p>就算开启的http服务关掉，也能正常访问
<code>npm install workbox-webpack-plugin --save-dev</code>  </p>
<p>webpack.prod.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">plugins: [</span><br><span class="line"><span class="keyword">new</span> WorkboxPlugin.GenerateSW(&#123;</span><br><span class="line">  clientsClaim: <span class="literal">true</span>,</span><br><span class="line">  skipWaiting: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>index.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">'serviceWorker'</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line">  <span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, () =&gt; &#123;</span><br><span class="line">    navigator.serviceWorker.register(<span class="string">'/service-worker.js'</span>).then(<span class="function"><span class="params">registration</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'service-worker registed'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="dev-server"><a href="#dev-server" class="headerlink" title="dev - server"></a>dev - server</h1><p>http请求代理  </p>
<p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">  proxy: &#123;</span><br><span class="line">    <span class="comment">// 将发送到/react/api下的请求转发到http://xxx.com</span></span><br><span class="line">    <span class="string">'/react/api'</span>: <span class="string">'http://xxx.com'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果测试为请求a.json，实际上线时需要请求b.json  </p>
<p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">  proxy: &#123;</span><br><span class="line">    <span class="string">'/react/api'</span>: &#123;</span><br><span class="line">      target: <span class="string">'http://xxx.com'</span>,</span><br><span class="line">      <span class="comment">// 如果转发到https</span></span><br><span class="line">      secure: <span class="literal">false</span>,</span><br><span class="line">      pathRewrite: &#123;</span><br><span class="line">        <span class="comment">// 匹配到这里，如果需要a.json，则拿b.json</span></span><br><span class="line">        <span class="string">'a.json'</span>: <span class="string">'b.json'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 解决某些网站对changeOrigin的限制</span></span><br><span class="line">      changeOrigin: <span class="literal">true</span>，</span><br><span class="line">      headers: &#123;</span><br><span class="line">        host: <span class="string">''</span>,</span><br><span class="line">        cookie: <span class="string">''</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="单页面路由问题"><a href="#单页面路由问题" class="headerlink" title="单页面路由问题"></a>单页面路由问题</h1><p>如果不用router类的插件，访问a.com/b则会向后端请求此页面，从而找不到页面。  </p>
<p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">  historyApiFallback: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="提高-webpack-打包速度"><a href="#提高-webpack-打包速度" class="headerlink" title="提高 webpack 打包速度"></a>提高 webpack 打包速度</h1><ol>
<li>更新webpack、node版本</li>
<li>在尽可能少的模块上应用loader<ul>
<li>include</li>
<li>exclude</li>
</ul>
</li>
<li>plugin尽可能精简，并确保可靠性<ul>
<li>dev环境不需要代码压缩</li>
</ul>
</li>
<li><p>resolve参数</p>
<ul>
<li>webpack.common.js<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">resolve: &#123;</span><br><span class="line">  <span class="comment">// 当去目录找文件时，先找以js、jsx为结尾的</span></span><br><span class="line">  <span class="comment">// ./component</span></span><br><span class="line">  <span class="comment">// ./component.js</span></span><br><span class="line">  <span class="comment">// ./component.jsx</span></span><br><span class="line">  extensions: [<span class="string">'.js'</span>, <span class="string">'.jsx'</span>],</span><br><span class="line">  <span class="comment">// 当路径为文件夹时自动查找文件</span></span><br><span class="line">  mainFiles: [<span class="string">'index'</span>],</span><br><span class="line">  <span class="comment">// 引入别名</span></span><br><span class="line">  alias: &#123;</span><br><span class="line">    components: path.resolve(__dirname, <span class="string">'../src/components'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>DLLPlugin
webpack.dll.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">'production'</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    <span class="comment">// 对于哪些模块做dll打包</span></span><br><span class="line">    vendors: [<span class="string">'react'</span>, <span class="string">'react-dom'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">'[name].dll.js'</span>,</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'../dll'</span>)</span><br><span class="line">    library: <span class="string">'[name]'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.DllPlugin(&#123;</span><br><span class="line">      name: <span class="string">'[name]'</span>,</span><br><span class="line">      path: path.resolv(__dirname, <span class="string">'../dll/[name].manifest.json'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>package.json
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "build:dll": "webpack --config ./build/webpack.dll.js"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>npm i add-asset-html-webpack-plugin --save</code></p>
<p>webpack.common.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">plugin: [</span><br><span class="line">  <span class="comment">// 在index.html里加入什么</span></span><br><span class="line">  <span class="keyword">new</span> AddAssetHtmlWebpackPlugin(&#123;</span><br><span class="line">    filepath: path.resolve(__dirname, <span class="string">'../dll/vendors.dll.js'</span>)</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="comment">// 配合webpack，查找映射关系</span></span><br><span class="line">  <span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</span><br><span class="line">    manifest: path.resolve(__dirname, <span class="string">'../dll/vendors.manifest.json'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>打包出的dll会在全局变量vendors里，其他代码从此变量获取  </p>
<p>当模块很多时，可能会有多个dll文件
webpack.common.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> plugins = []</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="comment">// 拿到目录下所有的文件列表</span></span><br><span class="line"><span class="keyword">const</span> files = fs.reddirSync(path.resolve(__dirname, <span class="string">'../dll'</span>))</span><br><span class="line"></span><br><span class="line">files.forEach(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/.*\.dll\.js/</span>.test(file)) &#123;</span><br><span class="line">    plugins.push(</span><br><span class="line">      <span class="keyword">new</span> AddAssetHtmlWebpackPlugin(&#123;</span><br><span class="line">        filepath: path.resolve(__dirname, <span class="string">'../dll'</span> + file)</span><br><span class="line">      &#125;)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/.*\.mainfest\.json/</span>.test(file)) &#123;</span><br><span class="line">    plugins.push(</span><br><span class="line">      <span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</span><br><span class="line">        manifest: path.resolve(__dirname, <span class="string">'../dll'</span> + file)</span><br><span class="line">      &#125;)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>控制包文件大小
对代码拆分，或去除不用的模块  </p>
</li>
<li><p>多进程打包</p>
</li>
</ol>
<ul>
<li>thread-loader</li>
<li>parallel-webpack</li>
<li>happypack</li>
</ul>
<ol>
<li><p>sourceMap
分环境打包</p>
</li>
<li><p>结合stats分析打包
webpack自带</p>
</li>
</ol>
<h1 id="编写Loader"><a href="#编写Loader" class="headerlink" title="编写Loader"></a>编写Loader</h1><p>这里的例子是替换字指定字符串中的文字</p>
<p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">'./src/index.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  resolveLoader: &#123;</span><br><span class="line">    <span class="comment">// 使用loader时先去node_modules里找，然后去loaders里找</span></span><br><span class="line">    modules: [<span class="string">'node_modules'</span>, <span class="string">'./loaders'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.js/</span>,</span><br><span class="line">      use: [</span><br><span class="line">        &#123;</span><br><span class="line">          loader: <span class="string">'replaceLoader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            name: <span class="string">'naaaame'</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'[name].js'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>/src/index.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'aaaaaa'</span>)</span><br></pre></td></tr></table></figure></p>
<p>/loaders/replaceLoader.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里不能使用箭头函数</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = loaderUtils.getOptions(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">const</span> callback = <span class="keyword">this</span>.async()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 异步返回方式</span></span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = source.replace(<span class="string">'a'</span>, options.name)</span><br><span class="line">    callback(<span class="literal">null</span>, result)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>更多配置查看官方文档</p>
<h1 id="编写Plugin"><a href="#编写Plugin" class="headerlink" title="编写Plugin"></a>编写Plugin</h1><p>这个例子是在打包最后放置文件时，创建一个新的文件</p>
<p>webpack.config.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> CopyrightWebpackPlugin = <span class="built_in">require</span>(<span class="string">'./plugins/copyright-webpack-plugin'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">'./src/index.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> CopyrightWebpackPlugin(&#123;</span><br><span class="line">      name: <span class="string">'naaaame'</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'[name].js'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>/plugins/copyright-webpack-plugin.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CopyrightWebpackPlugin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">    <span class="comment">// 参数</span></span><br><span class="line">    <span class="built_in">console</span>.log(options);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生命周期，此为同步时间点</span></span><br><span class="line">    compiler.hooks.emit.tap(<span class="string">'CopyrightWebpackPlugin'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="comment">// do</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调试</span></span><br><span class="line">    <span class="keyword">debugger</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生命周期，此为异步时间点</span></span><br><span class="line">    compiler.hooks.emit.tapAsync(<span class="string">'CopyrightWebpackPlugin'</span>, (compilation, cb) =&gt; &#123;</span><br><span class="line">      compilation.assets[<span class="string">'copyright.txt'</span>] = &#123;</span><br><span class="line">        source: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">'文件内容'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        size: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="comment">//  文件字节长度</span></span><br><span class="line">          <span class="keyword">return</span> <span class="number">12</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      cb()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = CopyrightWebpackPlugin</span><br></pre></td></tr></table></figure></p>
<p>package.json
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "debug": "node --inspect --inspect-brk node_modules/webpack/bin/webpack.js",</span><br><span class="line">  "build": "webpack"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h1 id="写一个类似Webpack的工具"><a href="#写一个类似Webpack的工具" class="headerlink" title="写一个类似Webpack的工具"></a>写一个类似Webpack的工具</h1><h2 id="依赖包"><a href="#依赖包" class="headerlink" title="依赖包"></a>依赖包</h2><p><code>yarn add @babel/parser</code><br><code>yarn add @babel/traverse</code><br><code>yarn add @babel/core</code>
<code>yarn add @babel/preset-env</code></p>
<h2 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h2><ul>
<li>/src/index.js</li>
<li>/src/message.js</li>
<li>/src/word.js</li>
<li>/bundler.js</li>
</ul>
<h2 id="文件内容"><a href="#文件内容" class="headerlink" title="文件内容"></a>文件内容</h2><p>/src/index.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> message <span class="keyword">from</span> <span class="string">'./message.js'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(message);</span><br></pre></td></tr></table></figure></p>
<p>/src/message.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; word &#125; <span class="keyword">from</span> <span class="string">'./word.js'</span>;</span><br><span class="line"><span class="keyword">const</span> message = <span class="string">`say <span class="subst">$&#123;word&#125;</span>`</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> message</span><br></pre></td></tr></table></figure></p>
<p>/src/word.js
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> word = <span class="string">'hello'</span></span><br><span class="line"><span class="keyword">export</span> &#123; word &#125;</span><br></pre></td></tr></table></figure></p>
<p>编译文件 <code>/bundler.js</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取文件信息</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">'@babel/parser'</span>)</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">'@babel/traverse'</span>).default</span><br><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">'@babel/core'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拿到入口文件内容</span></span><br><span class="line"><span class="keyword">const</span> moduleAnalyser = <span class="function"><span class="params">filename</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> content = fs.readFileSync(filename, <span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 抽象语法树</span></span><br><span class="line">  <span class="keyword">const</span> ast = parser.parse(content, &#123;</span><br><span class="line">    sourceType: <span class="string">'module'</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dependencies = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 找到import语句</span></span><br><span class="line">  traverse(ast, &#123;</span><br><span class="line">    <span class="comment">// 需要提取的语法作为函数名，之后会被执行</span></span><br><span class="line">    ImportDeclaration(&#123; node &#125;) &#123;</span><br><span class="line">      <span class="comment">// 根目录的绝对路径</span></span><br><span class="line">      <span class="keyword">const</span> dirname = path.dirname(filename)</span><br><span class="line">      <span class="keyword">const</span> newFile = <span class="string">'./'</span> + path.join(dirname, node.source.value)</span><br><span class="line">      <span class="comment">// 依赖的文件</span></span><br><span class="line">      dependencies[node.source.value] = newFile</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// AST转浏览器运行的代码</span></span><br><span class="line">  <span class="keyword">const</span> &#123; code &#125; = babel.transformFromAst(ast, <span class="literal">null</span>, &#123;</span><br><span class="line">    presets: [<span class="string">"@babel/preset-env"</span>],</span><br><span class="line"></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    filename,</span><br><span class="line">    dependencies,</span><br><span class="line">    code</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 所有模块信息</span></span><br><span class="line"><span class="keyword">const</span> makeDependenciesGraph = <span class="function"><span class="params">entry</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> entryModule = moduleAnalyser(entry)</span><br><span class="line">  <span class="keyword">const</span> graphArray = [entryModule]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对入口文件循环</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; graphArray.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> item = graphArray[i];</span><br><span class="line">    <span class="keyword">const</span> &#123; dependencies &#125; = item</span><br><span class="line">    <span class="keyword">if</span> (dependencies) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 对依赖循环，深入到内部获取依赖，并添加到数组</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> dependencies) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dependencies.hasOwnProperty(key)) &#123;</span><br><span class="line">          graphArray.push(moduleAnalyser(dependencies[key]))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> graph = &#123;&#125;</span><br><span class="line">  graphArray.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; dependencies, code &#125; = item</span><br><span class="line">    graph[item.filename] = &#123;</span><br><span class="line">      dependencies,</span><br><span class="line">      code</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> graph</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> generateCode  = <span class="function"><span class="params">entry</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> graph = <span class="built_in">JSON</span>.stringify(makeDependenciesGraph(entry))</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 避免污染全局，用闭包</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">    (function(graph) &#123;</span></span><br><span class="line"><span class="string">      function require(module) &#123;</span></span><br><span class="line"><span class="string">        // 相对路径转换</span></span><br><span class="line"><span class="string">        function localRequire(relativePath) &#123;</span></span><br><span class="line"><span class="string">          return require(graph[module].dependencies[relativePath])</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        // 记录导出的结果</span></span><br><span class="line"><span class="string">        var exports = &#123;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        function init(require, exports, code) &#123;</span></span><br><span class="line"><span class="string">          // 重写内部的require，返回绝对路径</span></span><br><span class="line"><span class="string">          eval(code)</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        init(localRequire, exports, graph[module].code)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        return exports</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      require('<span class="subst">$&#123;entry&#125;</span>')</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#125;)(<span class="subst">$&#123;graph&#125;</span>)</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = generateCode(<span class="string">'./src/index.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span>(code)</span><br></pre></td></tr></table></figure></p>
<h2 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h2><p><code>node .\bundler.js</code><br>输出为解析<code>index.js</code>文件后的代码，浏览器可直接执行</p>
</div></article><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/08/02/27.记录/"><i class="fa fa-chevron-left">  </i><span>常用代码记录</span></a></div><div class="next-post pull-right"><a href="/2019/07/09/36.kubernetes尝鲜并搭建服务/"><span>kubernetes尝鲜并搭建服务</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2022 By Doug Flands</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">+1S</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>