<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="从docker到k8s部署指南"><meta name="keywords" content=""><meta name="author" content="Doug Flands"><meta name="copyright" content="Doug Flands"><title>从docker到k8s部署指南 | Flands Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="manifest" href="/manifest.json"><link rel="manifest" href="/manifest.json"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker"><span class="toc-number">1.</span> <span class="toc-text">Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么使用docker"><span class="toc-number">1.1.</span> <span class="toc-text">为什么使用docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#本地搭建及K8S部署"><span class="toc-number">1.2.</span> <span class="toc-text">本地搭建及K8S部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-设置"><span class="toc-number">1.2.1.</span> <span class="toc-text">docker 设置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#file编写"><span class="toc-number">1.3.</span> <span class="toc-text">file编写</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#React前端"><span class="toc-number">1.3.1.</span> <span class="toc-text">React前端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Golang后端"><span class="toc-number">1.3.2.</span> <span class="toc-text">Golang后端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常用命令"><span class="toc-number">1.4.</span> <span class="toc-text">常用命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker-compose"><span class="toc-number">2.</span> <span class="toc-text">docker-compose</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes"><span class="toc-number">3.</span> <span class="toc-text">Kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#搭建"><span class="toc-number">3.1.</span> <span class="toc-text">搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署服务"><span class="toc-number">3.2.</span> <span class="toc-text">部署服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#traefik"><span class="toc-number">3.2.1.</span> <span class="toc-text">traefik</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#介绍及说明"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">介绍及说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置文件讲解"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">配置文件讲解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#本地搭建"><span class="toc-number">3.2.1.3.</span> <span class="toc-text">本地搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#云上搭建"><span class="toc-number">3.2.1.4.</span> <span class="toc-text">云上搭建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-搭建"><span class="toc-number">3.2.2.</span> <span class="toc-text">Nginx 搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#consul-amp-zookeeper"><span class="toc-number">3.2.3.</span> <span class="toc-text">consul &amp; zookeeper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gogs"><span class="toc-number">3.2.4.</span> <span class="toc-text">gogs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis"><span class="toc-number">3.2.5.</span> <span class="toc-text">redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka"><span class="toc-number">3.2.6.</span> <span class="toc-text">kafka</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka-manager"><span class="toc-number">3.2.7.</span> <span class="toc-text">kafka-manager</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#K8S-常用命令"><span class="toc-number">3.3.</span> <span class="toc-text">K8S 常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署项目配套服务"><span class="toc-number">3.4.</span> <span class="toc-text">部署项目配套服务</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://flands.com/avatar/192.jpg"></div><div class="author-info__name text-center">Doug Flands</div><div class="author-info__description text-center">Flands</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">47</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">19</span></a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Flands Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">从docker到k8s部署指南</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-13</time></div><div class="article-container" id="post-content"><p>主要介绍docker、docker-compose、dockerfile编写以及项目部署k8s。 
部署项目: </p>
<ul>
<li>traefik</li>
<li>react 前端</li>
<li>golang 微服务后端</li>
<li>consul</li>
<li>kafka</li>
<li>kafka-manager</li>
<li>zookeeper</li>
<li>redis</li>
<li>gogs</li>
</ul>
<a id="more"></a>
<p>所有配置文件均可在github上下载</p>
<blockquote>
<p><a href="https://github.com/DougFlands/k8s-config" target="_blank" rel="noopener">https://github.com/DougFlands/k8s-config</a>  </p>
</blockquote>
<h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><h2 id="为什么使用docker"><a href="#为什么使用docker" class="headerlink" title="为什么使用docker"></a>为什么使用docker</h2><ul>
<li>环境统一<ul>
<li>每个人node版本不一样，导致前端项目依赖构建的时候可能出错</li>
<li>Golang 版本不一样，特性API可能变化导致非后端人员出错不好排查</li>
</ul>
</li>
<li>环境隔离，容器之间只能端口访问互相不影响</li>
<li>比虚拟机开销低</li>
</ul>
<h2 id="本地搭建及K8S部署"><a href="#本地搭建及K8S部署" class="headerlink" title="本地搭建及K8S部署"></a>本地搭建及K8S部署</h2><h3 id="docker-设置"><a href="#docker-设置" class="headerlink" title="docker 设置"></a>docker 设置</h3><p>先从官网下载docker安装，windows用户必须是旗舰版以上，家庭版不能用。  </p>
<blockquote>
<p><a href="https://www.docker.com/" target="_blank" rel="noopener">https://www.docker.com/</a>
安装后启动，小图标右键 - 设置，要修改的内容如下
Resources</p>
<ul>
<li>ADVANCED<ul>
<li>底下的Disk image location 修改路径，不然镜像打包时占用几十G，C盘可能不够用</li>
<li>配置够的话可以增加cpu和内存占用</li>
</ul>
</li>
<li>FILE SHARING<ul>
<li>勾选一个盘，docker容器与宿主机文件共享时才能使用
Docker Engine</li>
</ul>
</li>
<li>registry-mirrors <ul>
<li>镜像下载，推荐使用阿里源，在阿里云控制台里，google 一下如何找到。  </li>
<li>其他的两个源也可以用。</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;https://registry.docker-cn.com&quot;,</span><br><span class="line">&quot;https://docker.mirrors.ustc.edu.cn&quot;,</span><br><span class="line">&quot;https://xxx.mirror.aliyuncs.com&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="file编写"><a href="#file编写" class="headerlink" title="file编写"></a>file编写</h2><p>部署docker后项目肯定要编写dockerfile，构建为镜像文件  </p>
<h3 id="React前端"><a href="#React前端" class="headerlink" title="React前端"></a>React前端</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:latest as builder</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span> /usr/src/app</span><br><span class="line">USER root</span><br><span class="line"></span><br><span class="line">COPY . /usr/src/app</span><br><span class="line">RUN npm config set registry https://registry.npm.taobao.org  \</span><br><span class="line">  &amp;&amp; npm i \</span><br><span class="line">  &amp;&amp; npm run build</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FROM nginx</span><br><span class="line"></span><br><span class="line">WORKDIR /usr/share/nginx/html/</span><br><span class="line">USER root</span><br><span class="line"></span><br><span class="line">COPY --from=builder /usr/src/app/docker/nginx.conf /etc/nginx/conf.d/default.conf</span><br><span class="line">COPY --from=builder /usr/src/app/dist  /usr/share/nginx/html/</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD ["nginx", "-g", "daemon off;"]</span><br></pre></td></tr></table></figure>
<p>文件如上，放在根目录或者项目某个文件夹内。<br>逐行解释，有些命令相同的不重复解释  </p>
<ol>
<li>FROM node:latest as builder<ul>
<li>前端项目，构建时的环境为node，所以基础镜像为node</li>
<li>as builder，起一个名字，后面会用到</li>
</ul>
</li>
<li>WORKDIR /usr/src/app<ul>
<li>在docker环境内的工作目录</li>
</ul>
</li>
<li>USER root<ul>
<li>登录权限为root用户</li>
</ul>
</li>
<li>COPY . /usr/src/app<ul>
<li>COPY 命令，第一个参数为宿主机的项目目录，第二个参数为复制到哪个目录下</li>
<li>同样的还有ADD命令，不过官方推荐COPY，可以搜下不同</li>
</ul>
</li>
<li>RUN xxx<ul>
<li>运行命令行</li>
<li>这里先设置npm源，然后安装依赖，打包</li>
<li>换行的话最后加 <code>\</code>，下一行加&amp;&amp;，不换行直接加 <code>&amp;&amp;</code> 即可</li>
<li>如果构建错误，可以在这里用 ls 等命令查看输出日志</li>
</ul>
</li>
<li>FROM nginx<ul>
<li>多阶段构建，一个优化手段，可以搜一下</li>
<li>上面的node镜像中依赖包很大，打包出来可能有1G+，但实际要用的只有dist目录</li>
<li>这里前端项目容器需要单独能运行，所以需要nginx指向目录并开启端口，使其他服务能访问到</li>
</ul>
</li>
<li>COPY –from=builder<ul>
<li>第一行的as builder用处就来了，表示从镜像的某个目录下复制文件到此构建镜像的目录中</li>
<li>这里的两行COPY表示将nginx设置和前端项目构建的dist复制到本镜像中</li>
</ul>
</li>
<li>EXPOSE 80<ul>
<li>镜像暴露端口，nginx用到</li>
</ul>
</li>
<li>CMD [“nginx”, “-g”, “daemon off;”]<ul>
<li>容器启动后要运行的命令</li>
<li>同样可以使用 ENTRYPOINT 可以搜下区别</li>
</ul>
</li>
</ol>
<p>构建命令及说明<br><code>docker build --network host -t account ./ -f ./deploy/docker/account.dockerfile</code></p>
<ul>
<li>–network host 表示使用宿主机的网络环境，可能用到代理什么的。</li>
<li>-t account ./ 打包出的镜像名称，以及构建时目录的上下文，这里的上下文指COPY的第一个参数运行上下文。</li>
<li>-f ./deploy/docker/account.dockerfile dockerfile配置文件存放目录。</li>
<li>建议使用上面的命令行在项目根目录构建，参数顺序不能乱调，重要的是，运行上下文的问题。</li>
<li>如果上下文在某个文件夹里，则docker image构建时，docker是访问不到文件夹外的文件的。</li>
<li>比如如果运行命令在src目录里，则docker是的COPY . 上下文是在src下，package.json是无法访问的，就算使用RUN cd ..改变目录也不行。</li>
<li>因为使用了多阶段构建，打包完后会有两个镜像，一个是account，一个是<code>&lt;none&gt;</code>。</li>
<li>account是我们要的，<code>&lt;none&gt;</code>是构建第一阶段node环境出来的镜像。</li>
</ul>
<h3 id="Golang后端"><a href="#Golang后端" class="headerlink" title="Golang后端"></a>Golang后端</h3><p>我自己的项目为Golang 微服务化的后端，所以这里的例子也以此构建
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.13</span>.<span class="number">5</span> as builder</span><br><span class="line"><span class="keyword">ENV</span> GO111MODULE=on</span><br><span class="line"><span class="keyword">ENV</span> GOPROXY=https://goproxy.cn</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span> /go/src/admin</span><br><span class="line">COPY . /go/src/admin</span><br><span class="line">RUN mkdir dist \</span><br><span class="line">    &amp;&amp; cd service/account \</span><br><span class="line">    &amp;&amp; CGO_ENABLED=0 go build -a -installsuffix cgo \</span><br><span class="line">    &amp;&amp; cp -r /go/src/admin/service/account/account /go/src/admin/dist</span><br><span class="line"></span><br><span class="line">FROM alpine:latest</span><br><span class="line">COPY --from=builder /go/src/admin/dist /usr/bin/server</span><br><span class="line">WORKDIR /usr/bin/server</span><br><span class="line">RUN chmod -R 777 /usr/bin/server</span><br><span class="line"></span><br><span class="line">ENTRYPOINT ["./account"]</span><br><span class="line">#CMD exec /bin/sh -c "trap : TERM INT; (while true; do sleep 1000; done) &amp; wait"</span><br><span class="line">EXPOSE 80</span><br></pre></td></tr></table></figure></p>
<p>逐行解释，部分命令跟前端重合，不重复讲</p>
<ol>
<li>ENV<ul>
<li>环境变量，go需要用到的</li>
</ul>
</li>
<li>RUN<ul>
<li>mkdir dist 创建文件夹，将编译的程序放进去</li>
<li>CGO_ENABLED=0 go build -a -installsuffix cgo 关闭cgo，不然有报错，具体可以搜一下</li>
</ul>
</li>
<li>FROM alpine:latest<ul>
<li>alpine镜像，一个小巧的linux系统</li>
<li>里面没有bash，所以进入运行中的容器命令要用sh <code>docker exec -it xx sh</code></li>
</ul>
</li>
<li>RUN chmod -R 777 /usr/bin/server<ul>
<li>设置目录权限</li>
</ul>
</li>
<li>#CMD exec /bin/sh -c “trap : TERM INT; (while true; do sleep 1000; done) &amp; wait”<ul>
<li>这段注释了，有时候会用到</li>
<li>镜像构建成功但镜像运行失败的话，这句某些情况可以阻止运行挂掉，可以进到运行的容器内运行命令</li>
</ul>
</li>
</ol>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><ul>
<li>列出所有镜像 <code>docker image list</code></li>
<li>删除无用的镜像 <code>docker rmi $(docker images -f dangling=true -q)</code></li>
<li>进入容器 <code>docker exec -it xx bash</code></li>
<li>查看实例 <code>docker ps -a</code></li>
<li>停止 <code>docker stop xx</code></li>
<li>删除 <code>docker rm xx</code></li>
<li>运行 <code>docker run -d --net=backend -p 宿主机端口:容器端口 -v 宿主机目录:容器目录 account</code></li>
</ul>
<h1 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h1><p>容器编排，不需要 <code>docker run</code> 然后加一堆参数<br>本地运行时可以使用这个，比K8S方便，就是如果服务器有k8s则要写两套配置<br>docker-compose.yml
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  mysql:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">docker.io/mysql</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">3306</span><span class="string">:3306</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      MYSQL_ROOT_PASSWORD:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"/data/mysql/data:/var/lib/mysql"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"/data/mysql/conf:/etc/mysql/conf.d"</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  gogs:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">docker.io/gogs/gogs</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">10022</span><span class="string">:10022</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">10080</span><span class="string">:3000</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"/data/gogs/:/data"</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  nginx:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">docker.io/nginx</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">443</span><span class="string">:443</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">gogs</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"/data/nginx/nginx.conf:/etc/nginx/nginx.conf:ro"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"/data/www:/www"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"/data/nginx/conf.d:/etc/nginx/conf.d"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"/data/nginx/keys:/etc/nginx/keys"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"/data/nginx/err:/etc/nginx/err"</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">backend</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  backend:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">bridge</span></span><br><span class="line"><span class="attr">    ipam:</span></span><br><span class="line"><span class="attr">      driver:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line"><span class="attr">      - subnet:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"><span class="attr">        gateway:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>跟docker启动参数差不多</li>
<li>depends_on<ul>
<li>前置运行的容器，等这个容器运行后再运行当前容器</li>
</ul>
</li>
</ul>
<p>常用命令</p>
<ul>
<li>docker-compose down 删除所有容器</li>
<li>docker-compose stop 停止一个已运行的容器，但不删除他</li>
<li>docker-compose start 启动被停止的容器</li>
<li>docker-compose build 构建或重新构建服务</li>
<li>docker-compose up -d 会在后台启动容器并使它们运行</li>
<li>docker restart 76e79889f101  重启某个容器</li>
<li>docker-compose restart 重启所有容器</li>
</ul>
<p>关于搭建mysql,gogs服务，可以看下我的一篇文章 </p>
<blockquote>
<p><a href="https://flands.com/2018/11/20/30.docker">https://flands.com/2018/11/20/30.docker</a></p>
</blockquote>
<h1 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h1><h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><p>大陆用户因为众所周知的原因，这里k8s很难启动，所以需要特殊的方式。
注意: 全程不要挂代理！全程不要挂代理！全程不要挂代理！否则k8s访问本地服务会出问题！<br>中途有错误可以在<code>C:\ProgramData\DockerDesktop/service.txt</code>里找到报错，如果出现访问网址404的错误，把代理关掉。  </p>
<ol>
<li><p>按照链接让k8s启动，能启动就可以了
<code>https://github.com/AliyunContainerService/k8s-for-docker-desktop</code>  </p>
</li>
<li><p>部署dashboard
命令行可能出现403验证的问题，可以将文件下载下来执行。<br>recommended 版本会变化，项目地址如下，在releases里查找对应docker的版本</p>
<blockquote>
<p><a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard</a>
<code>kubectl create -f .\recommendedv.yaml</code><br>部署token，这个是创建admin-user<br>dashboard-adminuser.yaml  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<p><code>kubectl create -f .\dashboard-adminuser.yaml</code>  </p>
<p>查看 Token  找到 admin-user-token
<code>kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk &#39;{print $1}&#39;)</code><br>开启服务<br><code>kubectl proxy</code>  </p>
<p>dashboard有v2版本，查看地址有两种<br>v1<br><code>http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</code><br>v2<br><code>http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</code>  </p>
<p>查看服务，可能用到<br><code>kubectl get pods,svc --all-namespaces -o wide</code>  </p>
<p>至此k8s应该可以访问了。</p>
<p>云上推荐使用提供的 容器服务，可以做到ci/cd那套玩法，镜像中心构建自己的镜像，配置好触发器即可。</p>
<h2 id="部署服务"><a href="#部署服务" class="headerlink" title="部署服务"></a>部署服务</h2><h3 id="traefik"><a href="#traefik" class="headerlink" title="traefik"></a>traefik</h3><h4 id="介绍及说明"><a href="#介绍及说明" class="headerlink" title="介绍及说明"></a>介绍及说明</h4><blockquote>
<p><a href="https://docs.traefik.io/" target="_blank" rel="noopener">https://docs.traefik.io/</a></p>
</blockquote>
<p>一个均衡负载器，支持动态路由以及中间件，配合微服务非常好用。<br>这里有个问题，在本地可以使用 LoadBalancer 方式部署，将POD的80\443端口暴露给宿主机，然后所有流量通过traefik进行转发。但是在腾讯云上，NodePort暴露的端口只能在30000-32767之间，无法直接暴露80/443端口。而 LoadBalancer 由云厂商接管，使用这个需要付费。为了规避这个问题，要在宿主机上直接搭建一个 nginx，将所有的80/443端口流量转发到 traefik 的端口上。<br>本地和云上搭建配置文件有些不一样。<br>配置在github/traefik &amp;&amp; github/traefik-tencent 里</p>
<h4 id="配置文件讲解"><a href="#配置文件讲解" class="headerlink" title="配置文件讲解"></a>配置文件讲解</h4><ul>
<li><code>crd,rbac</code> 不多介绍，就是新增权限和 IngressRoute 类型路由</li>
<li><code>config</code> 用默认的就行，具体可以看官网说明</li>
<li><code>route.yaml</code>中<code>Host</code>部分网址，改成你想要的，比如<code>traefik.k8s.com</code><ul>
<li>配置文件包含了一份 consul 的配置，不需要可以删掉</li>
<li>IngressRoute: 路由配置，每次新增路由使用该配置进行新增/修改路由</li>
<li>IngressRoute: entryPoints 参数， web 表示80端口，websecure 表示用了SSL的443端口</li>
<li>Secret: 存储在k8s内的秘钥</li>
<li>Middleware: 中间件，路由时会经过此配置，对应IngressRoute中middlewares配置</li>
</ul>
</li>
</ul>
<h4 id="本地搭建"><a href="#本地搭建" class="headerlink" title="本地搭建"></a>本地搭建</h4><ol>
<li>对 <code>config,crd,deploy,rbac,route</code> 执行命令 <code>kubectl apply -f ./xxx.yaml</code> 即可</li>
<li>有的教程写要带上 <code>-n kube-system</code> 部署到 kube-system 命名空间里，但是在腾讯云中部署时会出错，实测不带也可以</li>
<li>dashboard 里可以看到服务启动了，然后直接输入 <code>localhost:8080</code> 可以访问 traefik dashboard</li>
<li>设置hosts <code>127.0.0.1 traefik.k8s.com</code>，即可使用地址访问traefik dashboard，不再需要额外放开8080端口</li>
</ol>
<h4 id="云上搭建"><a href="#云上搭建" class="headerlink" title="云上搭建"></a>云上搭建</h4><p>云上有些不一样</p>
<ul>
<li>云上POD暴露端口由server控制，原理是云上的POD内部有端口映射工具。</li>
<li>云上建议对域名访问加traefik的基础认证。</li>
<li>不要使用腾讯云提供的面板搭建traefik，用文件里的，否则报错。搭建完后记得配置Service。</li>
</ul>
<p>先创建认证，再进行部署</p>
<ul>
<li><code>route.yaml</code> 的 <code>Secret</code>部分有个用户名密码字串，为访问域名时的基础。</li>
<li>搜一下 <code>在线生成 htpasswd</code> ，用格式<code>user:pwd</code>生成md5加密字符串</li>
<li>因为k8s存储的secret只能存储base64编码字符串或ssl，所以转出来的字符再用base64编码</li>
<li>将字串放到 Secret 的<code>users</code>下面</li>
<li>云上部署用 <code>\traefik-tencent</code> 文件替换掉 <code>\traefik</code> 内的文件，再执行 <code>kubectl apply -f ./xxx.yaml</code>  </li>
</ul>
<p>云上的traefik搭建就完成了，接下来需要宿主机的nginx转发端口</p>
<h3 id="Nginx-搭建"><a href="#Nginx-搭建" class="headerlink" title="Nginx 搭建"></a>Nginx 搭建</h3><ol>
<li><p>PCRE pcre-devel 安装
PCRE(Perl Compatible Regular Expressions) 是一个Perl库，包括 perl 兼容的正则表达式库。nginx 的 http 模块使用 pcre 来解析正则表达式，所以需要在 linux 上安装 pcre 库，pcre-devel 是使用 pcre 开发的一个二次开发库。nginx也需要此库。<br><code>yum install -y pcre pcre-devel</code></p>
</li>
<li><p>zlib 安装
zlib 库提供了很多种压缩和解压缩的方式， nginx 使用 zlib 对 http 包的内容进行 gzip ，所以需要在 Centos 上安装 zlib 库。<br><code>yum install -y zlib zlib-devel</code></p>
</li>
<li><p>OpenSSL 安装
OpenSSL 是一个强大的安全套接字层密码库，囊括主要的密码算法、常用的密钥和证书封装管理功能及 SSL 协议，并提供丰富的应用程序供测试或其它目的使用。<br>nginx 不仅支持 http 协议，还支持 https（即在ssl协议上传输http），所以需要在 Centos 安装 OpenSSL 库。<br><code>yum install -y openssl openssl-devel</code>  </p>
</li>
</ol>
<p>在官网下载安装包</p>
<blockquote>
<p><a href="https://nginx.org/en/download.html" target="_blank" rel="noopener">https://nginx.org/en/download.html</a><br><code>wget -c https://nginx.org/download/nginx-1.16.1.tar.gz</code><br><code>tar zxvf nginx-1.16.1.tar.gz</code><br><code>cd nginx-1.16.1</code><br><code>./configure --with-http_gzip_static_module --with-http_ssl_module --with-http_v2_module</code><br><code>make &amp;&amp; make install</code><br>启动 <code>/usr/local/nginx/sbin/nginx</code>  </p>
</blockquote>
<p>设置开机自启<br><code>vim /etc/rc.local</code> 最下面加入一行 <code>/usr/local/nginx/sbin/nginx</code> 就可以了</p>
<p>配置转发到 traefik ，直接贴出配置文件供参考。<br>我这里用了ssl，不需要的可以自行修改。域名的SSL在nginx上设置，traefik 配置无效。<br><code>http://127.0.0.1:30443</code> 端口为 traefik 的端口
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">server &#123;  </span><br><span class="line">   listen 80;  </span><br><span class="line">   server_name xxx.cn;  </span><br><span class="line">   return 301 https://$server_name$request_uri;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">   listen 443 ssl http2;</span><br><span class="line">   server_name xxx.cn;</span><br><span class="line">   ssl_certificate   /data/nginx/keys/xxx.cn.crt;</span><br><span class="line">   ssl_certificate_key  /data/nginx/keys/xxx.cn.key;</span><br><span class="line">   ssl_session_timeout 10m;</span><br><span class="line">   ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:d!MD5:!RC4:!DHE;</span><br><span class="line">   ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">   location / &#123;</span><br><span class="line">      proxy_pass http://127.0.0.1:30443;</span><br><span class="line">      proxy_redirect default;</span><br><span class="line">      proxy_set_header Host $host;</span><br><span class="line">      proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">      client_max_body_size 10m;</span><br><span class="line">      client_body_buffer_size 128k;</span><br><span class="line">      proxy_connect_timeout 90;</span><br><span class="line">      proxy_send_timeout 90;</span><br><span class="line">      proxy_read_timeout 90;</span><br><span class="line">      proxy_buffer_size 4k;</span><br><span class="line">      proxy_buffers 4 32k;</span><br><span class="line">      proxy_busy_buffers_size 64k;</span><br><span class="line">      proxy_temp_file_write_size 64k;</span><br><span class="line">   &#125;</span><br><span class="line">   access_log  /usr/local/nginx/logs/traefik.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样就搭建好了，可以访问网站试下能不能进入到 traefik dashboard 里</p>
<h3 id="consul-amp-zookeeper"><a href="#consul-amp-zookeeper" class="headerlink" title="consul &amp; zookeeper"></a>consul &amp; zookeeper</h3><p>单机版本，配置查看github项目即可<br>consul 云上无需部署 <code>services.yaml</code>  </p>
<h3 id="gogs"><a href="#gogs" class="headerlink" title="gogs"></a>gogs</h3><p>需要修改镜像地址，腾讯云的docker hub 找不到 gogs 镜像，所以自己编译，并镜像公开了，如果不是腾讯云部署可以改为docker hub地址<br>app.ini 存放到 <code>/data/gogs/gogs/conf/</code> 内<br>具体配置查看 gogs 文档  </p>
<blockquote>
<p><a href="https://gogs.io/" target="_blank" rel="noopener">https://gogs.io/</a></p>
</blockquote>
<h3 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h3><p>redis.conf 修改 <code>requirepass</code> 值为访问密码
配置的主要点在于映射 <code>/etc/redis</code> 目录，目录下有 <code>redis.conf</code> ，所以将 redis.conf 存放到 <code>/data/redis/conf/</code> 内
运行命令 <code>redis-server</code>, 运行参数 <code>/etc/redis/redis.conf</code>  </p>
<p>redis.conf 官网下载的，去掉了注释，实际上要用的就前两行，其他的都是默认值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">requirepass xxx</span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure></p>
<h3 id="kafka"><a href="#kafka" class="headerlink" title="kafka"></a>kafka</h3><p>因为走内网，可以不提供公网服务，于是也没加验证。<br>deployment 中有几个值讲一下: </p>
<ul>
<li>KAFKA_ADVERTISED_HOST_NAME: kafka 服务ip的值，由于不能填写127.0.0.1或localhost所以等创建好server后再修改配置</li>
<li>KAFKA_ZOOKEEPER_CONNECT: zookeeper 的ip，所以要等zookeeper搭建后再创建kafka</li>
<li>KAFKA_ADVERTISED_LISTENERS: 外网服务ip，不需要外网服务可以不写
测试一下<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it kafka-6b6c6d4d4d-tv2qq /bin/bash</span><br><span class="line">kafka-console-producer.sh --broker-list 172.16.255.xx:9092 --topic oss</span><br><span class="line">kafka-console-consumer.sh --bootstrap-server 172.16.255.xx:9092 --topic oss</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="kafka-manager"><a href="#kafka-manager" class="headerlink" title="kafka-manager"></a>kafka-manager</h3><p>修改 deployment 中 <code>ZK_HOSTS</code> 值为 zookeeper 的ip地址
面板上新建clusters时，连接为zk地址，<code>zk-ip:port</code></p>
<h2 id="K8S-常用命令"><a href="#K8S-常用命令" class="headerlink" title="K8S 常用命令"></a>K8S 常用命令</h2><p>资源类型: secret, pod 等等</p>
<ul>
<li>创建某个资源 <code>kubectl apply -f ./xxx.yaml</code></li>
<li>获取某个资源 <code>kubectl get xxx</code></li>
<li>删除某个资源 <code>kubectl detele 资源类型 xxx</code></li>
<li>按文件删除某个资源 <code>kubectl detele -f ./xxx.yaml</code></li>
</ul>
<h2 id="部署项目配套服务"><a href="#部署项目配套服务" class="headerlink" title="部署项目配套服务"></a>部署项目配套服务</h2><p>由于我个人项目有 consul 所以也可以根据上面的 consul 文件夹中进行配置。  </p>
</div></article><div class="post-meta__tag-list"></div><nav id="pagination"><div class="next-post pull-right"><a href="/2020/04/13/46.使用docker构建本地开发环境/"><span>使用docker构建本地开发环境</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By Doug Flands</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">+1S</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>